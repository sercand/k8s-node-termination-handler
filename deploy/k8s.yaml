# Copyright 2018 Google Inc. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http:#www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: apps/v1
kind: DaemonSet
metadata:
  labels:
    name: node-termination-handler
  name: node-termination-handler
  namespace: kube-system
spec:
  selector:
    matchLabels:
      name: node-termination-handler
  updateStrategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        name: node-termination-handler
    spec:
      # Necessary to reboot node
      hostPID: true
      serviceAccountName: node-termination-handler
      affinity:
        nodeAffinity:
          # Restrict to GPU nodes or preemptible nodes
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: cloud.google.com/gke-accelerator
                    operator: Exists
              - matchExpressions:
                  - key: cloud.google.com/gke-preemptible
                    operator: Exists
      containers:
        - image: gcr.io/otsimocloud/gke-node-termination-handler:6387a44
          name: node-termination-handler
          command: ["./node-termination-handler"]
          args:
          - "--logtostderr"
          - "--exclude-pods=$(POD_NAME):$(POD_NAMESPACE)"
          - "-v=10"
          - "--taint=cloud.google.com/impending-node-termination::NoSchedule"
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_NODENAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
          resources:
            limits:
              cpu: 20m
              memory: 30Mi
      tolerations:
        # Run regardless of any existing taints.
        - effect: NoSchedule
          operator: Exists
        - effect: NoExecute
          operator: Exists
